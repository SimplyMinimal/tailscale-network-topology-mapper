<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tailscale Network Topology</title>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        
        #network-container {
            width: 100%;
            height: 800px;
            border: 1px solid #ddd;
            background-color: white;
        }
        
        .view-mode-container {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: #ffffff;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 12px;
        }
        
        .enhanced-search-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ffffff;
            padding: 15px;
            border: 2px solid #007bff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 300px;
        }
        
        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .legend-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            min-width: 250px;
        }
        
        .legend-header {
            background-color: #f8f9fa;
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: bold;
        }
        
        .legend-content {
            padding: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 10px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="view-mode-container">
        <h4>View Mode</h4>
        <div>Interactive Network Topology</div>
        <div style="font-size: 10px; color: #666; margin-top: 4px;">
            Company: example.com
        </div>
    </div>

    <div id="network-container"></div>
    
    <div class="enhanced-search-container">
        <input type="text" id="search-input" class="search-input" placeholder="Search nodes...">
        <div id="search-results" style="margin-top: 8px; font-size: 12px; color: #666;"></div>
    </div>
    
    <div class="legend-panel">
        <div class="legend-header" onclick="toggleLegend()">
            <span>Legend</span>
        </div>
        <div id="legend-content" class="legend-content">
            <h4>Node Types (Colors)</h4>
            <div class="legend-item">
                <span class="legend-color" style="background-color: #FFFF00;"></span>
                <span>Groups & Autogroups</span>
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background-color: #00cc66;"></span>
                <span>Tags</span>
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background-color: #ff6666;"></span>
                <span>Hosts & IPs</span>
            </div>
            
            <h4>Rule Types (Shapes)</h4>
            <div class="legend-item">
                <span style="margin-right: 10px;">●</span>
                <span>ACL Rules Only</span>
            </div>
            <div class="legend-item">
                <span style="margin-right: 10px;">▲</span>
                <span>Grant Rules Only</span>
            </div>
            <div class="legend-item">
                <span style="margin-right: 10px;">⬢</span>
                <span>Both ACL & Grant Rules</span>
            </div>
        </div>
    </div>
    
    <script>
        
        const nodes = new vis.DataSet(JSON.parse("[{\"borderWidth\":2,\"chosen\":true,\"color\":\"#FFFF00\",\"font\":{\"color\":\"black\",\"size\":12},\"id\":\"autogroup:tagged\",\"label\":\"autogroup:tagged\",\"shape\":\"dot\",\"title\":\"autogroup:tagged\\nType: group\\n\"},{\"borderWidth\":2,\"chosen\":true,\"color\":\"#00cc66\",\"font\":{\"color\":\"black\",\"size\":12},\"id\":\"tag:public:80,443\",\"label\":\"tag:public:80,443\",\"shape\":\"dot\",\"title\":\"tag:public:80,443\\nType: tag\\n\"},{\"borderWidth\":2,\"chosen\":true,\"color\":\"#FFFF00\",\"font\":{\"color\":\"black\",\"size\":12},\"id\":\"group:developers\",\"label\":\"group:developers\",\"shape\":\"triangle\",\"title\":\"group:developers\\nType: group\\nMembers: dev1@example.com, dev2@example.com\\n\"},{\"borderWidth\":2,\"chosen\":true,\"color\":\"#00cc66\",\"font\":{\"color\":\"black\",\"size\":12},\"id\":\"tag:shared-resources:*\",\"label\":\"tag:shared-resources:*\",\"shape\":\"triangle\",\"title\":\"tag:shared-resources:*\\nType: tag\\n\"},{\"borderWidth\":2,\"chosen\":true,\"color\":\"#FFFF00\",\"font\":{\"color\":\"black\",\"size\":12},\"id\":\"autogroup:member\",\"label\":\"autogroup:member\",\"shape\":\"hexagon\",\"title\":\"autogroup:member\\nType: group\\n\"},{\"borderWidth\":2,\"chosen\":true,\"color\":\"#FFFF00\",\"font\":{\"color\":\"black\",\"size\":12},\"id\":\"group:system_admin\",\"label\":\"group:system_admin\",\"shape\":\"dot\",\"title\":\"group:system_admin\\nType: group\\nMembers: admin@example.com, sysadmin@example.com\\n\"},{\"borderWidth\":2,\"chosen\":true,\"color\":\"#ff6666\",\"font\":{\"color\":\"black\",\"size\":12},\"id\":\"*:*\",\"label\":\"*:*\",\"shape\":\"dot\",\"title\":\"*:*\\nType: host\\n\"},{\"borderWidth\":2,\"chosen\":true,\"color\":\"#00cc66\",\"font\":{\"color\":\"black\",\"size\":12},\"id\":\"tag:production:443\",\"label\":\"tag:production:443\",\"shape\":\"dot\",\"title\":\"tag:production:443\\nType: tag\\n\"},{\"borderWidth\":2,\"chosen\":true,\"color\":\"#00cc66\",\"font\":{\"color\":\"black\",\"size\":12},\"id\":\"tag:database:5432\",\"label\":\"tag:database:5432\",\"shape\":\"dot\",\"title\":\"tag:database:5432\\nType: tag\\n\"},{\"borderWidth\":2,\"chosen\":true,\"color\":\"#00cc66\",\"font\":{\"color\":\"black\",\"size\":12},\"id\":\"tag:web-server\",\"label\":\"tag:web-server\",\"shape\":\"dot\",\"title\":\"tag:web-server\\nType: tag\\n\"},{\"borderWidth\":2,\"chosen\":true,\"color\":\"#FFFF00\",\"font\":{\"color\":\"black\",\"size\":12},\"id\":\"autogroup:internet:443,80\",\"label\":\"autogroup:internet:443,80\",\"shape\":\"dot\",\"title\":\"autogroup:internet:443,80\\nType: group\\n\"},{\"borderWidth\":2,\"chosen\":true,\"color\":\"#00cc66\",\"font\":{\"color\":\"black\",\"size\":12},\"id\":\"tag:development:*\",\"label\":\"tag:development:*\",\"shape\":\"triangle\",\"title\":\"tag:development:*\\nType: tag\\n\"},{\"borderWidth\":2,\"chosen\":true,\"color\":\"#00cc66\",\"font\":{\"color\":\"black\",\"size\":12},\"id\":\"tag:public:*\",\"label\":\"tag:public:*\",\"shape\":\"dot\",\"title\":\"tag:public:*\\nType: tag\\n\"}]"));
        const edges = new vis.DataSet(JSON.parse("[{\"arrows\":{\"to\":{\"enabled\":true}},\"color\":{\"color\":\"#848484\",\"highlight\":\"#ff0000\"},\"from\":\"autogroup:member\",\"smooth\":{\"enabled\":true,\"type\":\"continuous\"},\"to\":\"tag:public:*\",\"width\":2},{\"arrows\":{\"to\":{\"enabled\":true}},\"color\":{\"color\":\"#848484\",\"highlight\":\"#ff0000\"},\"from\":\"group:system_admin\",\"smooth\":{\"enabled\":true,\"type\":\"continuous\"},\"to\":\"*:*\",\"width\":2},{\"arrows\":{\"to\":{\"enabled\":true}},\"color\":{\"color\":\"#848484\",\"highlight\":\"#ff0000\"},\"from\":\"autogroup:tagged\",\"smooth\":{\"enabled\":true,\"type\":\"continuous\"},\"to\":\"tag:production:443\",\"width\":2},{\"arrows\":{\"to\":{\"enabled\":true}},\"color\":{\"color\":\"#848484\",\"highlight\":\"#ff0000\"},\"from\":\"autogroup:tagged\",\"smooth\":{\"enabled\":true,\"type\":\"continuous\"},\"to\":\"tag:database:5432\",\"width\":2},{\"arrows\":{\"to\":{\"enabled\":true}},\"color\":{\"color\":\"#848484\",\"highlight\":\"#ff0000\"},\"from\":\"tag:web-server\",\"smooth\":{\"enabled\":true,\"type\":\"continuous\"},\"to\":\"autogroup:internet:443,80\",\"width\":2},{\"arrows\":{\"to\":{\"enabled\":true}},\"color\":{\"color\":\"#848484\",\"highlight\":\"#ff0000\"},\"from\":\"group:developers\",\"smooth\":{\"enabled\":true,\"type\":\"continuous\"},\"to\":\"tag:development:*\",\"width\":2},{\"arrows\":{\"to\":{\"enabled\":true}},\"color\":{\"color\":\"#848484\",\"highlight\":\"#ff0000\"},\"from\":\"autogroup:member\",\"smooth\":{\"enabled\":true,\"type\":\"continuous\"},\"to\":\"tag:shared-resources:*\",\"width\":2}]"));
        const data = { nodes: nodes, edges: edges };

        
        const options = JSON.parse("{\"configure\":{\"enabled\":false},\"edges\":{\"arrows\":{\"to\":{\"enabled\":true,\"scaleFactor\":1}},\"color\":{\"color\":\"#848484\",\"highlight\":\"#ff0000\"},\"smooth\":{\"enabled\":true,\"type\":\"continuous\"},\"width\":2},\"interaction\":{\"hover\":true,\"selectConnectedEdges\":true,\"tooltipDelay\":200},\"nodes\":{\"borderWidth\":2,\"chosen\":true,\"font\":{\"size\":12}},\"physics\":{\"barnesHut\":{\"centralGravity\":0.3,\"damping\":0.09,\"gravitationalConstant\":-2000,\"springConstant\":0.04,\"springLength\":95},\"enabled\":true,\"stabilization\":{\"iterations\":100}}}");

        
        const searchMetadata = JSON.parse("{\"edges\":{\"autogroup:member-\\u003etag:public:*\":{\"from\":\"autogroup:member\",\"to\":\"tag:public:*\",\"rule_type\":\"ACL\",\"line_numbers\":[14]},\"autogroup:member-\\u003etag:shared-resources:*\":{\"from\":\"autogroup:member\",\"to\":\"tag:shared-resources:*\",\"rule_type\":\"Grant\",\"line_numbers\":[45]},\"autogroup:tagged-\\u003etag:database:5432\":{\"from\":\"autogroup:tagged\",\"to\":\"tag:database:5432\",\"rule_type\":\"ACL\",\"line_numbers\":[24]},\"autogroup:tagged-\\u003etag:production:443\":{\"from\":\"autogroup:tagged\",\"to\":\"tag:production:443\",\"rule_type\":\"ACL\",\"line_numbers\":[24]},\"group:developers-\\u003etag:development:*\":{\"from\":\"group:developers\",\"to\":\"tag:development:*\",\"applications\":[\"tailscale.com/cap/funnel\"],\"rule_type\":\"Grant\",\"line_numbers\":[42]},\"group:system_admin-\\u003e*:*\":{\"from\":\"group:system_admin\",\"to\":\"*:*\",\"rule_type\":\"ACL\",\"line_numbers\":[19]},\"tag:web-server-\\u003eautogroup:internet:443,80\":{\"from\":\"tag:web-server\",\"to\":\"autogroup:internet:443,80\",\"rule_type\":\"ACL\",\"line_numbers\":[29]}},\"nodes\":{\"*:*\":{\"id\":\"*:*\",\"type\":\"host\",\"rule_type\":\"ACL\"},\"autogroup:internet:443,80\":{\"id\":\"autogroup:internet:443,80\",\"type\":\"group\",\"rule_type\":\"ACL\"},\"autogroup:member\":{\"id\":\"autogroup:member\",\"type\":\"group\",\"rule_type\":\"Mixed\"},\"autogroup:tagged\":{\"id\":\"autogroup:tagged\",\"type\":\"group\",\"rule_type\":\"ACL\"},\"group:developers\":{\"id\":\"group:developers\",\"type\":\"group\",\"rule_type\":\"Grant\",\"members\":[\"dev1@example.com\",\"dev2@example.com\"]},\"group:system_admin\":{\"id\":\"group:system_admin\",\"type\":\"group\",\"rule_type\":\"ACL\",\"members\":[\"admin@example.com\",\"sysadmin@example.com\"]},\"tag:database:5432\":{\"id\":\"tag:database:5432\",\"type\":\"tag\",\"rule_type\":\"ACL\"},\"tag:development:*\":{\"id\":\"tag:development:*\",\"type\":\"tag\",\"rule_type\":\"Grant\"},\"tag:production:443\":{\"id\":\"tag:production:443\",\"type\":\"tag\",\"rule_type\":\"ACL\"},\"tag:public:*\":{\"id\":\"tag:public:*\",\"type\":\"tag\",\"rule_type\":\"ACL\"},\"tag:public:80,443\":{\"id\":\"tag:public:80,443\",\"type\":\"tag\",\"rule_type\":\"ACL\"},\"tag:shared-resources:*\":{\"id\":\"tag:shared-resources:*\",\"type\":\"tag\",\"rule_type\":\"Grant\"},\"tag:web-server\":{\"id\":\"tag:web-server\",\"type\":\"tag\",\"rule_type\":\"ACL\"}}}");
        
        
        const container = document.getElementById('network-container');
        const network = new vis.Network(container, data, options);
        
        
        document.getElementById('search-input').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            const results = document.getElementById('search-results');
            
            if (query === '') {
                results.textContent = '';
                
                const allNodes = nodes.get();
                allNodes.forEach(node => {
                    node.color = getOriginalColor(node.id);
                });
                nodes.update(allNodes);
                return;
            }
            
            
            const allNodes = nodes.get();
            let matchCount = 0;
            
            allNodes.forEach(node => {
                if (node.id.toLowerCase().includes(query) || 
                    (node.label && node.label.toLowerCase().includes(query))) {
                    node.color = '#ff6b6b'; 
                    matchCount++;
                } else {
                    node.color = 'rgba(200,200,200,0.3)'; 
                }
            });
            
            nodes.update(allNodes);
            results.textContent = 'Found ' + matchCount + ' matching nodes';
        });
        
        function getOriginalColor(nodeId) {
            
            if (nodeId.startsWith('group:') || nodeId.startsWith('autogroup:')) {
                return '#FFFF00';
            } else if (nodeId.startsWith('tag:')) {
                return '#00cc66';
            } else {
                return '#ff6666';
            }
        }
        
        function toggleLegend() {
            const content = document.getElementById('legend-content');
            if (content.style.display === 'none') {
                content.style.display = 'block';
            } else {
                content.style.display = 'none';
            }
        }
        
        
        network.on("click", function(params) {
            if (params.nodes.length > 0) {
                const selectedNode = params.nodes[0];
                const connectedNodes = network.getConnectedNodes(selectedNode);
                const allNodes = nodes.get();
                
                allNodes.forEach(node => {
                    if (connectedNodes.includes(node.id) || node.id === selectedNode) {
                        node.color = getOriginalColor(node.id);
                    } else {
                        node.color = 'rgba(200,200,200,0.5)';
                    }
                });
                
                nodes.update(allNodes);
            }
        });
    </script>
</body>
</html>